---
title: Java内存分配
date: 2021-08-31 11:14:46
tags: 编程
categories:
- [Java, Java基础]
---

### 内存区域、内存模型
* 内存区域：即运行时数据区域，指JVM对于不同类型数据在内存中的存储方式
* 内存模型（JMM：Java Memory Model）：定义了线程与主内存之间的抽象关系，即JVM在内存中的工作方式，即JVM使用内存区域中的数据的方式

### JDK8之后的内存区域：
```
* Native Method Stacks（本地方法栈）
* Program Counter Register（程序计数器）
* Java Virtual Machine Stacks（JVM Stacks，即虚拟机栈）
    * 栈帧1（方法A）
        * 局部变量表
        * 操作栈
        * 动态连接
        * 方法返回地址
    * 栈帧2（方法B）
        * 局部变量表
        * 操作栈
        * 动态连接
        * 方法返回地址
* Heap（堆区）
    * Young区（新生代）
        * Eden
        * S0
        * S1
    * Old区（老年代）
* Metaspace（元数据区）
    * 常量池
    * 方法元信息
    * klass类元信息
* CodeCache（JIT编译产物） 
```

### Program Counter Register (程序计数器)
* 作用：当前线程所执行的字节码的行号指示器，当多线程切换时，使线程恢复后找到正确的执行位置
* 特点：
    * 内存占用少
    * 线程私有
    * 当前线程执行Java方法，计数器保存虚拟机中字节码指令地址；执行Native方法，记录null
    * 唯一一个在JVM规范中没有规定OutOfMemoryError的区域
   
### JVM Stacks
* 概念：
    * 活动线程：当前正在执行的线程
    * 当前帧：正在执行的方法对应的栈帧，由于只有栈顶帧有效，所以当前帧也是栈顶帧
    * 当前方法：正在执行的方法
* 简介：描述了Java方法执行的内存模型，每个方法在执行时都会创建一个栈帧（Stack Frame：栈中的一个元素，方法运行时的基础数据结构），存储局部变量表，操作数栈、动态连接、方法出口等。每一个方法从调用到执行完的过程，对应一个栈帧入栈出栈过程
* 作用：保存Java方法执行的时候需要的各种数据、参数
* 特点：
    * 线程私有
    * 生命周期与线程相同
    * 执行引擎运行时，所有指令都只能对当前帧操作
    * 一个方法对应一个栈帧
* **栈帧：**
    * 组成部分介绍：
        * 局部变量表
            * 作用：存放方法参数和局部变量，字节码指令中的STORE指令就是将操作栈中计算完成局部变量写到当前帧的局部变量表中
            * 特点：
                * 必须显示初始化，才能使用
                * 如果是非静态方法，会在index[0]位置存储方法所属对象的实例引用，占用4字节，后面存储方法参数和局部变量
    * JVM规定的异常：
        * 线程请求的栈深度大于JVM允许的深度，抛出StackOverflowError
        * 对于当前大多数可以拓展的JVM栈，在拓展时申请不到足够内存，抛出OutOfMemoryError

            
            
 
